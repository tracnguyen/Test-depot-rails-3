= content_for :head do
  = stylesheet_link_tag "colorPicker.css"
  = javascript_include_tag "jquery.inlineEdit.js", "jquery.colorPicker.js"

= content_for :heading do
  %h1 Status of applications

%ul{:id => 'sortable'}
  .col1
    .col11{:id => @first_stage.id}
      .editable
        = @first_stage.name
      .ineditable
        = @first_stage.name
    .col12
      = image_tag("edit-icon.png")
    .col13
      &nbsp;
    .col14
      .controlset
        %input{:class => "color", :id => "color#{@first_stage.id}", :type => "text", :value => @first_stage.color}
  .col2
    (initial stage)
    
  - @job_stages.each do |job_stage|
    %li{:id => "order_#{job_stage.id}"}
      .col1
        .col11{:id => job_stage.id}
          .editable
            = job_stage.name
          .ineditable
            = job_stage.name
          .progress{:style => "display: none"}
            %span
              Updating...  
            = image_tag "loading.gif", :alt => "Updating"
        .col12
          = image_tag("edit-icon.png")
        .col13
          = link_to image_tag("delete-icon.png"), config_job_stage_path(job_stage), :confirm => 'Are you sure?', :method => :delete
        .col14
          .controlset
            %input{:class => "color", :id => "color#{job_stage.id}", :type => "text", :value => job_stage.color}
  .clearfix

%button{:id => 'new_stage_button', :onclick => "$('#new_stage_form').show(); $(this).hide();"}
  New job stage
#new_stage_form
  Add a new Stage
  = form_for [:config, @job_stage] do |f|
    = f.text_field :name
    = submit_tag 'Add'
    or 
    %a{:href => "#", :onclick => "$('#new_stage_form').hide(); $('#new_stage_button').show();"}
      Cancel


:erb
  <script type='text/javascript'>
    $(document).ready(function() {
      $('.editable').inlineEdit({
        save: function(data) {
          var editable = $(this);
          var ineditable = $(this).siblings('.ineditable');
          var progress = $(this).siblings('.progress');
          
          $.ajax({
            type: 'PUT',
            url: '/config/job_stages/' + $(this).parent().attr('id'),
            data: {
              'stage[name]' : data.value,
            },
            beforeSend: function(){
              editable.hide();
              progress.show();
            },
            complete: function(){
              progress.hide();
            }
          })
        },
        cancel: function() {
          $(this).val($(this).next());
          $(this).hide();
          $(this).next().show();
        }
      });
      
      $('#sortable').sortable({
        items: 'li',
        cursor: 'move',
        update: function(e, data) {
          var order = $('#sortable').sortable('serialize');
          $.ajax({
            type: 'PUT',
            url: '/config/job_stages/1',
            data: order
          });
        }
      });
      
      $('.color').colorPicker();
      
      $('.color').change(function(e, data){
        var stage_id = $(this).attr('id').slice(5);
        
        $.ajax({
          type: 'PUT',
          url: '/config/job_stages/' + stage_id,
          data: {
            'stage[color]' : $(this).val(),
          }
        });
      });
      
      $('.col12 > img').click(function(){
        var stage = $(this).parent().parent();
        var e = stage.children(":first-child"); 
        e.children(".ineditable").hide();
        e.children(".editable").show();
        e.children(".editable").click();
      });
      
      <% if @job_stage.errors.empty? %>
        $('#new_stage_form').hide();
      <% else %>
        $('#new_stage_button').hide();
      <% end %>
    })
  </script>
